From bc33ec515bc885da761dbf3c7f76baf7c6c51cff Mon Sep 17 00:00:00 2001
From: vgdn1942 <vgdn1942@gmail.com>
Date: Fri, 3 Dec 2021 15:56:47 +0300
Subject: [PATCH] Disable F11 key and update KEY_ASSIST code

Change-Id: Iae557c5f818a3c7a5280f45d8539e86bfe420ae3
---
 .../server/policy/PhoneWindowManager.java     | 44 +++++++++++++------
 1 file changed, 30 insertions(+), 14 deletions(-)

diff --git a/services/core/java/com/android/server/policy/PhoneWindowManager.java b/services/core/java/com/android/server/policy/PhoneWindowManager.java
index 69784f815d97..ba7007b3c778 100644
--- a/services/core/java/com/android/server/policy/PhoneWindowManager.java
+++ b/services/core/java/com/android/server/policy/PhoneWindowManager.java
@@ -544,6 +544,7 @@ public class PhoneWindowManager implements WindowManagerPolicy {
     private ActivityTaskManagerInternal.SleepTokenAcquirer mScreenOffSleepTokenAcquirer;
     volatile boolean mKeyguardOccluded;
     boolean mMenuPressed;
+    boolean mAssistPressed;
     boolean mAppSwitchLongPressed;
     Intent mHomeIntent;
     Intent mCarDockIntent;
@@ -3126,6 +3127,11 @@ public class PhoneWindowManager implements WindowManagerPolicy {
                     }
                 }
                 break;
+            case KeyEvent.KEYCODE_F11:
+                if (!keyguardOn()) {
+                    return key_consumed;
+                }
+                break;
         }
 
         if (isValidGlobalKey(keyCode)
@@ -4174,28 +4180,38 @@ public class PhoneWindowManager implements WindowManagerPolicy {
                 break;
             }
             case KeyEvent.KEYCODE_ASSIST: {
-                final boolean longPressed = event.getRepeatCount() > 0;
-                if (down && (mAssistPressAction == Action.APP_SWITCH
-                        || mAssistLongPressAction == Action.APP_SWITCH)) {
-                    preloadRecentApps();
-                }
-                if (down && longPressed) {
-                    if (!keyguardOn() && mAssistLongPressAction != Action.NOTHING) {
-                        if (mAssistLongPressAction != Action.APP_SWITCH) {
-                            cancelPreloadRecentApps();
+                final int repeatCount = event.getRepeatCount();
+                final boolean longPress = (event.getFlags() & KeyEvent.FLAG_LONG_PRESS) != 0;
+                final boolean keyguardOn = keyguardOn();
+                if (down) {
+                    if (mMenuPressAction == Action.APP_SWITCH
+                            || mMenuLongPressAction == Action.APP_SWITCH) {
+                        preloadRecentApps();
+                    }
+                    if (repeatCount == 0) {
+                        mAssistPressed = true;
+                    } else if (longPress) {
+                        if (!keyguardOn && mAssistLongPressAction != Action.NOTHING) {
+                            if (mAssistLongPressAction != Action.APP_SWITCH) {
+                                cancelPreloadRecentApps();
+                            }
+                            performHapticFeedback(HapticFeedbackConstants.LONG_PRESS, false,
+                                    "Assist - Long Press");
+                            performKeyAction(mAssistLongPressAction, event);
+                            mAssistPressed = false;
                         }
-                        performHapticFeedback(HapticFeedbackConstants.LONG_PRESS, false,
-                            "Assist - Long Press");
-                        performKeyAction(mAssistLongPressAction, event);
                     }
                 }
 
-                if (!down && !longPressed) {
+                if (!down && mAssistPressed) {
                     if (mAssistPressAction != Action.APP_SWITCH) {
                         cancelPreloadRecentApps();
                     }
+                    mAssistPressed = false;
                     if (!canceled) {
-                        performKeyAction(mAssistPressAction, event);
+                        if (!keyguardOn && mAssistLongPressAction != Action.NOTHING) {
+                            performKeyAction(mAssistPressAction, event);
+                        }
                     }
                 }
                 result &= ~ACTION_PASS_TO_USER;
-- 
2.20.1

