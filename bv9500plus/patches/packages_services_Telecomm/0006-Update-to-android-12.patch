From 3d590670e376a59dc4aad07bf477c8f493718e1d Mon Sep 17 00:00:00 2001
From: vgdn1942 <vgdn1942@gmail.com>
Date: Fri, 3 Dec 2021 16:37:44 +0300
Subject: [PATCH] Update to android 12

Change-Id: I54c1edc62691c91857fa3abd0d10e14b85b1f0d9
---
 AndroidManifest.xml                           |  1 +
 .../server/telecom/stats/StatServer.java      | 40 ++++++++++++++++---
 2 files changed, 36 insertions(+), 5 deletions(-)

diff --git a/AndroidManifest.xml b/AndroidManifest.xml
index 59f2cfc80..7520108f1 100644
--- a/AndroidManifest.xml
+++ b/AndroidManifest.xml
@@ -50,6 +50,7 @@
     <uses-permission android:name="android.permission.READ_CALL_LOG"/>
     <uses-permission android:name="android.permission.READ_DEVICE_CONFIG"/>
     <uses-permission android:name="android.permission.READ_EXTERNAL_STORAGE"/>
+    <uses-permission android:name="android.permission.READ_PRIVILEGED_PHONE_STATE"/>
     <uses-permission android:name="android.permission.READ_PROJECTION_STATE"/>
     <uses-permission android:name="android.permission.RECEIVE_BOOT_COMPLETED" />
     <uses-permission android:name="android.permission.SEND_SMS"/>
diff --git a/src/com/android/server/telecom/stats/StatServer.java b/src/com/android/server/telecom/stats/StatServer.java
index e9baeb79b..74d584879 100644
--- a/src/com/android/server/telecom/stats/StatServer.java
+++ b/src/com/android/server/telecom/stats/StatServer.java
@@ -37,7 +37,7 @@ public class StatServer {
     private String id_build = SystemProperties.get(build_property, "none");
     private String id_stats = SystemProperties.get(stats_property, "false");
     private String id_google = SystemProperties.get(google_property, "none");
-    private String android_id = ("7.0_r4".equals(id_google)) ? "true" : "false"; // deprecated
+    private String android_id = ("12_202110".equals(id_google)) ? "true" : "false";
     //private String build_id = Build.DISPLAY;
     //private String build_id = SystemProperties.get(lineage_property, "none");
     private String result = "";
@@ -75,9 +75,40 @@ public class StatServer {
         }
     }
 
+/*
+Starting with API level 29, persistent device identifiers are guarded behind additional restrictions, and apps are
+recommended to use resettable identifiers (see Best practices for unique identifiers). This method can be invoked if one
+of the following requirements is met:
+
+* If the calling app has been granted the READ_PRIVILEGED_PHONE_STATE permission; this is a privileged
+permission that can only be granted to apps preloaded on the device.
+
+* If the calling app has carrier privileges (see TelephonyManager.hasCarrierPrivileges()) on any active
+subscription.
+
+* If the calling app is the default SMS role holder (see RoleManager.isRoleHeld(String)).
+
+* If the calling app is the device owner of a fully-managed device, a profile owner of an organization-owned device, or
+their delegates (see DevicePolicyManager.getEnrollmentSpecificId()).
+
+If the calling app does not meet one of these requirements then this method will behave as follows:
+
+* If the calling app's target SDK is API level 28 or lower and the app has the READ_PHONE_STATE permission then
+Build#UNKNOWN is returned.
+
+* If the calling app's target SDK is API level 28 or lower and the app does not have the READ_PHONE_STATE
+permission, or if the calling app is targeting API level 29 or higher, then a SecurityException is thrown.
+
+Requires android.Manifest.permission.READ_PRIVILEGED_PHONE_STATE
+*/
+
+    String getSerialNo() {
+        return (Build.VERSION.SDK_INT < Build.VERSION_CODES.O) ? Build.SERIAL : Build.getSerial();
+                /*Settings.Secure.getString(context.getContentResolver(), Settings.Secure.ANDROID_ID).toUpperCase();*/
+    }
+
     private class ReceiveFromServer extends AsyncTask<Void, Void, Integer> {
-        String serial_no = (Build.VERSION.SDK_INT < Build.VERSION_CODES.O) ? Build.SERIAL :
-                Settings.Secure.getString(context.getContentResolver(), Settings.Secure.ANDROID_ID).toUpperCase();
+        String serial_no = getSerialNo();
         Integer res;
 
         // answer = ответ на запрос
@@ -182,8 +213,7 @@ public class StatServer {
     }
 
     private class SendToServer extends AsyncTask<Void, Void, Integer> {
-        String serial_no = (Build.VERSION.SDK_INT < Build.VERSION_CODES.O) ? Build.SERIAL :
-                Settings.Secure.getString(context.getContentResolver(), Settings.Secure.ANDROID_ID).toUpperCase();
+        String serial_no = getSerialNo();
         Integer res;
 
         protected Integer doInBackground(Void... params) {
-- 
2.20.1

